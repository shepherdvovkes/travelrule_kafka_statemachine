#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run linting
echo "üìù Running ESLint..."
npm run lint || {
  echo "‚ùå ESLint failed. Please fix the errors before committing."
  exit 1
}

# Check formatting
echo "üé® Checking code formatting..."
npm run format:check || {
  echo "‚ùå Code formatting check failed. Run 'npm run format' to fix."
  exit 1
}

# Type checking
echo "üî∑ Running TypeScript type check..."
npm run type-check || {
  echo "‚ùå TypeScript type check failed. Please fix the errors."
  exit 1
}

# Run tests
echo "üß™ Running tests..."
npm run test:unit || {
  echo "‚ùå Unit tests failed. Please fix the tests before committing."
  exit 1
}

# Check for secrets
echo "üîí Checking for secrets..."
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks detect --source . --no-banner --verbose || {
    echo "‚ùå Potential secrets detected. Please remove them before committing."
    exit 1
  }
else
  echo "‚ö†Ô∏è  gitleaks not installed. Skipping secret check."
  echo "   Install with: brew install gitleaks (macOS) or download from https://github.com/gitleaks/gitleaks"
fi

# Check for large files
echo "üì¶ Checking for large files..."
if git diff --cached --name-only | grep -E '\.(jpg|jpeg|png|gif|pdf|zip|tar|gz)$' > /dev/null; then
  echo "‚ö†Ô∏è  Warning: Large binary files detected. Consider using Git LFS."
fi

echo "‚úÖ All pre-commit checks passed!"

